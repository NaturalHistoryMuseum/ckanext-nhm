{% extends "dwc/view.html" %}
{
{% block record %}

    {% if rec.collectionCode == 'BOT': %}
        {% do rec.update({'collectionCode':'BOT (Botany)'}) %}
    {% elif rec.collectionCode == 'MIN': %}
        {% do rec.update({'collectionCode':'MIN (Mineralogy)'}) %}
    {% elif rec.collectionCode == 'PAL': %}
        {% do rec.update({'collectionCode':'PAL (Paleontology)'}) %}
    {% elif rec.collectionCode == 'ZOO': %}
        {% do rec.update({'collectionCode':'ZOO (Zoology)'}) %}
    {% elif rec.collectionCode == 'BMNH(E)': %}
        {% do rec.update({'collectionCode':'NHM(E) (Entomology)'}) %}
    {% endif %}

    {% do rec.update(h.parse_dynamic_properties(rec)) %}

    {% set collection_date = [] %}

    {% for i in ['day', 'month', 'year']: %}

        {% if rec[i]: %}
            {% do collection_date.append(rec[i]) %}
        {% endif %}

    {% endfor %}

    {% if collection_date: %}
        {% do rec.update([('collectionDate', '-'.join(collection_date))]) %}
    {% endif %}

    {% set registered_weight_label = 'Registered weight' %}

    {% if rec.registeredWeightUnit: %}
        {% set registered_weight_label = 'Registered weight' + ' (' + rec.registeredWeightUnit + ')' %}
    {% else %}
        {% set registered_weight_label = 'Registered weight' %}
    {% endif %}

    {% set group_fields = [
        ('Classification', [
            ('scientificName', 'Scientific name'),
            ('kingdom', 'Kingdom'),
            ('phylum', 'Phylum'),
            ('class', 'Class'),
            ('order', 'Order'),
            ('suborder', 'Suborder'),
            ('superfamily', 'Superfamily'),
            ('family', 'Family'),
            ('subfamily', 'Subfamily'),
            ('genus', 'Genus'),
            ('subgenus', 'Subgenus'),
            ('specificEpithet', 'Species'),
            ('infraspecificEpithet', 'Subspecies'),
            ('taxonRank', 'Rank'),
            ('validity', 'Validity'),
            ('currentlyAcceptedName', 'Currently accepted name'),
            ('scientificNameAuthorship', 'Authorship')
        ]),
        ('Location', [
            ('continent', 'Continent'),
            ('waterBody', 'Water body'),
            ('islandGroup', 'Island group'),
            ('island', 'Island'),
            ('country', 'Country'),
            ('stateProvince', 'State / province'),
            ('county', 'County'),
            ('vice_county', 'Vice county'),
            ('parish', 'Parish'),
            ('town', 'Town'),
            ('mineral_complex', 'Mineral complex'),
            ('mine', 'Mine'),
            ('miningDistrict', 'Mining district'),
            ('tectonicProvince', 'Tectonic province'),
            ('geologyRegion', 'Geology region'),
            ('locality', 'Locality'),
            ('siteDescription', 'Site description'),
            ('minimumElevationInMeters','Minimum elevation (meters)'),
            ('maximumElevationInMeters','Maximum elevation (meters)'),
            ('minimumDepthInMeters','Minimum depth (meters)'),
            ('maximumDepthInMeters','Maximum depth (meters)'),
            ('verbatimLatitude','Latitude'),
            ('verbatimLongitude','Longitude'),
            ('decimalLatitude','Decimal latitude'),
            ('decimalLongitude','Decimal longitude'),
            ('geodeticDatum','Geodetic datum'),
            ('georeferenceProtocol','Georeferencing protocol'),
        ]),
        ('Collection event', [
            ('recordNumber', 'Collector number'),
            ('recordedBy', 'Collector'),
            ('collectionDate', 'Collection date'),
            ('eventTime', 'Collection time'),
            ('habitat', 'Habitat'),
            ('fieldNumber', 'Field number'),
            ('expeditionStartDate', 'Expedition start date'),
            ('vesselName', 'Vessel name'),
            ('vesselType', 'Vessel type'),
        ]),
        ('Identification', [
            ('identifiedBy', 'Identified by'),
            ('dateIdentified', 'Date identified'),
            ('identificationQualifier', 'Identification qualifier'),
            ('typeStatus', 'Type status'),
            ('identificationAsRegistered', 'Identification as registered'),
        ]),
        ('Specimen', [
            ('catalogNumber', 'Catalogue number'),
            ('collectionCode', 'Collection code'),
            ('collectionSubDepartment', 'Collection sub-department'),
            ('specimenUnit', 'Specimen unit'),
            ('curationUnit', 'Curation unit'),
            ('otherCatalogNumbers', 'Other catalogue numbers'),
            ('preparations', 'Preparations'),
            ('preservation', 'Preservation'),
            ('verbatimLabelData', 'Verbatim label data'),
            ('donorName', 'Donor name'),
            ('dateCatalogued', 'Date catalogued'),
            ('kindOfCollection', 'Kind of collection'),
            ('weight', 'Weight'),
            ('registrationCode', 'Registration code'),
            ('individualCount', 'Count'),
            ('sex', 'Sex'),
            ('stage', 'Stage'),
        ]),
        ('Mineralogy', [
            ('dateRegistered', 'Date registered'),
            ('occurrence', 'occurrence'),
            ('commodity', 'Commodity'),
            ('depositType', 'Deposit type'),
            ('texture', 'Texture'),
            ('identificationVariety', 'Identification variety'),
            ('identificationOther', 'Other identification'),
            ('hostRock', 'Host rock'),
            ('HostAge', 'Host age'),
            ('MineralisationAge', 'Mineralisation age'),
            ('RockAge', 'Rock age'),
            ('Ar-Arage', 'Ar-Ar age'),
        ]),
        ('Meteorite', [
            ('meteoriteType', 'Meteorite type'),
            ('meteoriteGroup', 'meteorite group'),
            ('chondriteAchondrite', 'Chondrite / achondrite'),
            ('meteoriteClass', 'Meteorite class'),
            ('petType', 'Petrology type'),
            ('petSubType', 'Petrology subtype'),
            ('recovery', 'Recovery'),
            ('recoveryDate', 'Recovery date'),
            ('recoveryWeight', 'Recovery weight'),
            (registered_weight_label, 'Registered weight'),
        ]),
        ('Botany', [
            ('exsiccati', 'Exsiccati'),
            ('exsiccatiNumber', 'Exsiccati number'),
            ('plantDescription', 'Plant description'),
            ('cultivated', 'Cultivated'),
            ('plantForm', 'Plant form'),
        ]),
        ('Silica gel', [
            ('populationCode', 'Population code'),
        ]),
        ('Nest', [
            ('nestShape', 'Nest shape'),
            ('nestSite', 'Nest site'),
        ]),
        ('Egg', [
            ('clutchSize', 'Clutch size'),
            ('setMark', 'Set mark'),
        ]),
        ('Parasite card', [
            ('barcode', 'Barcode'),
            ('parasite', 'Parasite'),
            ('parasiteStage', 'Parasite stage'),
            ('host', 'Host'),
            ('hostStage', 'Host stage'),
        ]),
        ('DNA Preparation', [
            ('extractionMethod', 'Extraction method'),
            ('resuspendedIn', 'Resuspended in'),
            ('totalVolume', 'Total volume')
        ]),
        ('Part', [
            ('partType', 'Part type')
        ]),
        ('Palaeontology', [
            ('catalogueDescription', 'Catalogue description'),
            ('biozone', 'Biozone'),
            ('sedimentology', 'Sedimentology'),
            ('sedimentaryFacies', 'Sedimentary facies'),
        ]),
    ] %}

    <table>

        {% for group, fields in group_fields: %}

            {% if h.fields_have_content(rec, fields) %}

                <tr><th colspan="3">{{ group }}</th></tr>

                {% for field, label in fields: %}

                    {% if rec[field]: %}
                        <tr>
                        <td><strong>{{ label }}:</strong></td>
                        <td colspan="2">{{ rec[field] }}</td>
                        </tr>
                    {% endif %}

                {% endfor %}

            {% endif %}

        {% endfor %}

        {% if h.fields_have_content(rec, ['earliestEonOrLowestEonothem', 'latestEonOrHighestEonothem', 'earliestEraOrLowestErathem', 'earliestPeriodOrLowestSystem', 'latestPeriodOrHighestSystem', 'earliestEpochOrLowestSeries', 'latestEpochOrHighestSeries', 'earliestAgeOrLowestStage', 'latestAgeOrHighestStage', 'lowestBiostratigraphicZone', 'highestBiostratigraphicZone', 'group', 'formation', 'member', 'bed']) %}

            <tr>
                <tr><th colspan="3">Geology</th></tr>
                <tr>
                    <td>&nbsp;</td>
                    <th>From</th>
                    <th>To</th>
                </tr>
            </tr>

            {% set geo_fields = [
                ('Eon', 'earliestEonOrLowestEonothem', 'latestEonOrHighestEonothem'),
                ('Era', 'earliestEraOrLowestErathem', 'latestEraOrHighestErathem'),
                ('Period', 'earliestPeriodOrLowestSystem', 'latestPeriodOrHighestSystem'),
                ('Epoch', 'earliestEpochOrLowestSeries', 'latestEpochOrHighestSeries'),
                ('Stage', 'earliestAgeOrLowestStage', 'latestAgeOrHighestStage'),
                ('Biostratigraphic zone', 'lowestBiostratigraphicZone', 'highestBiostratigraphicZone'),
            ] %}

            {% for time, from, to in geo_fields: %}

                {% if rec[from] or rec[to]: %}
                    <tr>
                        <td><strong>{{ time }}</strong></td>
                        <td>{{ rec[from] or '' }}</td>
                        <td>{{ rec[to] or '' }}</td>
                    </tr>
                {% endif %}

            {% endfor %}


            {% for field in ['group', 'formation', 'member', 'bed']: %}

                {% if rec[field]: %}
                    <tr>
                    <td><strong>{{ field|title }}:</strong></td>
                    <td colspan="2">{{ rec[field] }}</td>
                    </tr>
                {% endif %}

            {% endfor %}


        {% endif %}

        {% if rec.relatedResourceID: %}

        {% set rel_types = rec.relationshipOfResource.split(';') %}
        {% set related_records = {} %}

        {% for rel_type in rel_types: %}
            {% do related_records.update({rel_type: []}) %}
        {% endfor %}

        {% for i, id in enumerate(rec.relatedResourceID.split(';')): %}
            {% do related_records[rel_types[i]].append(id) %}
        {% endfor %}

        <tr>

            <tr><th colspan="3">Related records</th></tr>

            {% for type, records in related_records.items(): %}

                <tr>
                    <td><strong>{{ type|title }}</strong></td>
                    <td colspan="2">
                        <ul>
                            {% for record_id in records: %}
                                <li>
                                    {{ h.link_to(h.unique_identifier(record_id), h.url_for(controller='ckanext.nhm.controllers.record:RecordController', action='view', package_name=pkg.name, resource_id=res.id, record_id=record_id)) }}
                                </li>
                            {% endfor %}
                         </ul>

                    </td>
                </tr>

            {% endfor %}

        </tr>

    {% endif %}

    </table>

    {% if rec.associatedMedia: %}

        {% for src in rec.associatedMedia.split(';'): %}

            <img src="{{ src }}&width=100&height=100" />

        {% endfor %}

    {% endif %}


    {% set record_extent = h.get_record_point(rec) %}

    {% if record_extent %}
      {% snippet "snippets/record_map.html", extent=record_extent %}
    {% endif %}




{% endblock %}

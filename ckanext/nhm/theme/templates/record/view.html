{% extends "package/base.html" %}

{% set rec = c.record_dict %}
{% set res = c.resource %}
{% set pkg = c.pkg_dict or pkg_dict %}
{% set filter_fields = h.resource_view_get_fields(res) %}

{% block head_extras -%}
    {{ super() }}
    <meta property="og:title" content="{{ h.dataset_display_name(c.package) }} - {{ h.resource_display_name(res) }} - {{ c.record_title }} - {{ g.site_title }}">
{% endblock -%}

{% block subtitle %}{{ h.dataset_display_name(c.package) }} - {{ h.resource_display_name(res) }} - {{ c.record_title }} {% endblock %}

{% block breadcrumb_content_selected %}{% endblock %}

{% block breadcrumb_content %}
    {{ super() }}
    <li>{% link_for h.resource_display_name(res)|truncate(40), controller='package', action='resource_read', id=pkg.name, resource_id=res.id %}</li>
    <li class="active"><a href="">{{ c.record_title|truncate(30) }}</a></li>
{% endblock %}

{% block pre_primary %}

    {% block record %}
        <section class="module module-record">
            <div class="module-content">

                {% block page_header %}
                    <header class="page-header">
                        <div class="actions">
                            <ul>

                                <li>

                                    <a data-module="back-button" class="btn btn-primary" href="{{ h.url_for(controller='package', action='resource_read', id=pkg.name, resource_id=res.id) }}">
                                        <i class="icon-circle-arrow-left"></i>
                                    </a>

                                    {% resource 'ckanext-nhm/back-button' %}

                                </li>

                                <li>

                                    {# Taken from ckanpackager/snippets/package_resource.html, but altered anon + auth messages #}

                                    {% resource 'ckanext-ckanpackager/main' %}

                                    <a data-module="ckanpackager-download-link" data-module-anon_message="Please enter your email address below, and the record will be packaged and sent to you."
                                       data-module-auth_message="The record will be packaged and sent to the email address registered with your account."
                                       class="packager-link btn btn-primary" href="{{ h.url_for_package_resource(pkg.id, res.id, extra_filters={'_id': rec['_id']}) }}">
                                        <i class="icon-download"></i> Download
                                    </a>

                                </li>

                                <li>
                                    {% snippet "contact/snippets/modal_link.html", pkg=pkg, res=res, rec=rec, link_text="Contact record curator" %}
                                </li>

                            </ul>
                        </div>

                        {% if self.content_primary_nav() | trim %}
                            <ul class="nav nav-tabs">
                                {% block content_primary_nav %}{% endblock %}
                            </ul>
                        {% endif %}

                    </header>
                {% endblock %}


            </div>

            <div class="module-content">

                <div class="record-content">

                    {% block heading %}
                        <h1 class="page-heading">{{ c.record_title }}</h1>
                    {% endblock %}

                    {% block record_data %}

                        <table>
                            {% for field_name, value in c.field_data.items() %}
                                {% if h.record_display_field(field_name, value) %}

                                    <tr>
                                        <th>{{ h.field_name_label(field_name) }}:</th>

                                        <td>{{ value }}</td>

                                        <td width="50" class="filterable">
                                            {% if field_name in filter_fields %}
                                                <a title="View all records where {{ field_name }}={{ value }}"
                                                   href="{{ h.url_for(controller='package', action='resource_read', id=pkg.name, resource_id=res.id, filters='%s:%s' % (field_name, value)) }}">
                                                    <i class="icon-filter"></i>
                                                </a>
                                            {% endif %}
                                        </td>

                                    </tr>

                                {% endif %}
                            {% endfor %}

                        </table>

                    {% endblock %}

                </div>

                {% block record_map %}

                    {% if c.record_map %}
                        <h3>Location</h3>
                        {% snippet "record/snippets/map.html", extent=c.record_map %}
                    {% endif %}

                {% endblock %}

                <!--{% block record_images %}-->
                    <!--{% if c.images %}-->
                        <!--<h3>Images</h3>-->
                        <!--{% snippet 'gallery/snippets/gallery.html', images=c.images %}-->
                    <!--{% endif %}-->
                <!--{% endblock %}-->

            </div>
        </section>
    {% endblock %}
{% endblock %}

{% block primary_content %}
    {% block record_additional_information %}
        {% if res %}
            <section class="additional-info">
                {% block record_additional_information_inner %}
                    <div class="module-content">
                        <h3>{{ _('Additional Information') }}</h3>
                        <table class="table table-striped table-bordered table-condensed" data-module="table-toggle-more">
                            <thead>
                            <tr>
                                <th scope="col">{{ _('Field') }}</th>
                                <th scope="col">{{ _('Value') }}</th>
                            </tr>
                            </thead>
                            <tbody>

                            {% block record_additional_information_rows %}
                                <tr>
                                    <th scope="row">{{ _('Format') }}</th>
                                    <td>{{ res.mimetype_inner or res.mimetype or res.format or _('unknown') }}</td>
                                </tr>
                                <tr>
                                    <th scope="row">{{ _('License') }}</th>
                                    <td>{% snippet "snippets/license.html", pkg_dict=pkg, text_only=True %}</td>
                                </tr>
                                <tr class="toggle-more">
                                    <th scope="row">{{ _('Dataset') }}</th>
                                    <td>{{ pkg.name }}</td>
                                </tr>
                                <tr class="toggle-more">
                                    <th scope="row">{{ _('Dataset ID') }}</th>
                                    <td>{{ pkg.id }}</td>
                                </tr>
                                <tr class="toggle-more">
                                    <th scope="row">{{ _('Resource') }}</th>
                                    <td>{{ res.name }}</td>
                                </tr>
                                <tr class="toggle-more">
                                    <th scope="row">{{ _('Resource ID') }}</th>
                                    <td>{{ res.id }}</td>
                                </tr>
                            {% endblock %}

                            </tbody>
                        </table>
                    </div>
                {% endblock %}
            </section>
        {% endif %}
    {% endblock %}
{% endblock %}

{% block secondary_content %}

    {% block resource_license %}
        {% snippet "snippets/social.html", pkg_dict=pkg, res_dict=res, rec_dict=rec %}
    {% endblock %}

{% endblock %}